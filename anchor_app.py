import streamlit as st
import pandas as pd
import io
import base64
import datetime

# --- ×”×’×“×¨×•×ª ×¢××•×“ ×•×¢×™×¦×•×‘ (Page Config & CSS) ---
st.set_page_config(
    page_title="×× ×ª×•× ×™ '×”×¢×•×’×Ÿ' ×œ×ª×•×›× ×™×ª ×¢×‘×•×“×”",
    layout="wide",
    page_icon="âš“",
    initial_sidebar_state="expanded"
)

# ×”×–×¨×§×ª CSS ×œ×ª××™×›×” ××œ××” ×‘×¢×‘×¨×™×ª (RTL) ×•×”×“×¤×¡×” × ×§×™×™×”
st.markdown("""
<style>
    /* ×”×’×“×¨×•×ª ×›×™×•×•× ×™×•×ª ×•×¤×•× ×˜×™× */
    body {direction: rtl; text-align: right; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    .stApp {direction: rtl;}
    .stMarkdown, .stButton, .stSelectbox, .stHeader, .stSubheader, .stText, .stTable {text-align: right; direction: rtl;}
    
    /* ×¢×™×¦×•×‘ ×›×¨×˜×™×¡×™×•×ª */
    div.stTabs [data-baseweb="tab-list"] {gap: 10px;}
    div.stTabs [data-baseweb="tab"] {
        height: 50px;
        white-space: pre-wrap;
        background-color: #f0f2f6;
        border-radius: 4px 4px 0 0;
        gap: 1px;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    div.stTabs [aria-selected="true"] {
        background-color: #4e8cff;
        color: white;
    }

    /* ×¢×™×¦×•×‘ ×˜×‘×œ××•×ª */
    th {text-align: right !important; background-color: #e6f3ff !important; color: #000 !important;}
    td {text-align: right !important;}

    /* ×”×¡×ª×¨×ª ××œ×× ×˜×™× ×‘×”×“×¤×¡×” */
    @media print {
        .stSidebar, header, .stFileUploader, button {display: none !important;}
        .block-container {padding-top: 0 !important;}
    }
</style>
""", unsafe_allow_html=True)

# --- ×œ×•×’×™×§×” ×¤×“×’×•×’×™×ª (Pedagogical Logic & Data Maps) ---

def get_domain_strategies(domain):
    """
    ××—×–×™×¨ ××™×œ×•×Ÿ ×¢× ××¡×˜×¨×˜×’×™×•×ª ×”×ª×¢×¨×‘×•×ª ×œ×¤×™ ×ª×—×•×, ××—×•×œ×§ ×œ×§×˜×’×•×¨×™×•×ª.
    """
    strategies = {
        '×©×¤×”': {
            'school': '×”×˜×¨××ª ××•×¦×¨ ××™×œ×™×, ×©×™××•×© ×‘×˜×§×¡×˜×™× ××“×•×¨×’×™×, ×”×§×¨××” ×§×•×œ×™×ª, ×©×™××•×© ×‘×××¨×’× ×™× ×’×¨×¤×™×™× ×œ×›×ª×™×‘×”.',
            'home': '×§×¨×™××” ××©×•×ª×¤×ª ×©×œ 10 ×“×§×•×ª ×‘×™×•×, ××©×—×§×™ ××™×œ×™× ×‘× ×¡×™×¢×”.',
            'tech': '××¤×œ×™×§×¦×™×•×ª ×œ×”×§×¨××” (Text-to-Speech), ×”×§×œ×˜×ª ×ª×©×•×‘×•×ª ×‘××§×•× ×›×ª×™×‘×”.',
            'emotional': '×—×™×–×•×§ ×¢×œ ××××¥ ×•×œ× ×¨×§ ×¢×œ ×”×¦×œ×—×”, ×‘×—×™×¨×ª ×˜×§×¡×˜×™× ××ª×—×•××™ ×¢× ×™×™×Ÿ ××™×©×™×™×.'
        },
        '××ª××˜×™×§×”': {
            'school': '×©×™××•×© ×‘×××¦×¢×™ ×”××—×©×” ×§×•× ×§×¨×˜×™×™× (×‘×“×™×“×™×/×—×©×‘×•× ×™×™×”), ×“×£ × ×•×¡×—××•×ª ××™×©×™, ×¦××¦×•× ×¢×•××¡ ×—×–×•×ª×™ ×‘×“×£.',
            'home': '×©×™×œ×•×‘ ×—×©×‘×•×Ÿ ×‘×—×™×™ ×”×™×•××™×•× (×§× ×™×•×ª, ×‘×™×©×•×œ), ××©×—×§×™ ×§×œ×¤×™× ×—×©×‘×•× ×™×™×.',
            'tech': '××¤×œ×™×§×¦×™×•×ª ×ª×¨×’×•×œ ××©×—×§×™×•×ª (×›××• ×¢×©×¨ ××¦×‘×¢×•×ª), ××—×©×‘×•×Ÿ ×•×™×–×•××œ×™.',
            'emotional': '× ×˜×¨×•×œ ×—×¨×“×ª ××ª××˜×™×§×” ×¢"×™ ×—×•×•×™×ª ×”×¦×œ×—×” ×‘××©×™××•×ª ×§×˜× ×•×ª.'
        },
        '×§×©×‘': {
            'school': '×™×©×™×‘×” ×‘×§×“××ª ×”×›×™×ª×”, ×—×œ×•×§×ª ××©×™××•×ª ×œ×× ×•×ª ×§×˜× ×•×ª (Chunking), ×”×¤×¡×§×•×ª ×ª× ×•×¢×” ×™×–×•××•×ª.',
            'home': '×¡×™×“×•×¨ ×¡×‘×™×‘×ª ×œ××™×“×” ×©×§×˜×”, ×™×¦×™×¨×ª ×©×’×¨×” ×§×‘×•×¢×” ×•×‘×¨×•×¨×”.',
            'tech': '×©×™××•×© ×‘×˜×™×™××¨ ×•×™×–×•××œ×™ (Time Timer), ××•×–× ×™×•×ª ×× ×˜×¨×œ×•×ª ×¨×¢×©.',
            'emotional': '×©×™×—×•×ª ×¨×¤×œ×§×¦×™×” ×§×¦×¨×•×ª: "××” ×¢×–×¨ ×œ×™ ×œ×”×ª×¨×›×– ×”×™×•×?".'
        },
        '×¨×’×©×™': {
            'school': '××¨×—×‘ ×¨×’×™×¢×” ×‘×›×™×ª×”, "×›×¨×˜×™×¡ ×™×¦×™××”" ×œ×”×ª××•×•×¨×¨×•×ª, ××ª×Ÿ ×ª×¤×§×™×“ ××—×¨××™ ×•××¢×¦×™×.',
            'home': '×–××Ÿ ××™×›×•×ª ×”×•×¨×”-×™×œ×“ ×œ×œ× ××¡×›×™×, ×©×™×— ×¨×’×©×™ ×¢×œ ×‘×¡×™×¡ ×§×œ×¤×™× ×˜×™×¤×•×œ×™×™×.',
            'tech': '×™×•××Ÿ ×¨×’×©×•×ª ×“×™×’×™×˜×œ×™, ××¤×œ×™×§×¦×™×•×ª ××™×™× ×“×¤×•×œ× ×¡ ×œ×™×œ×“×™×.',
            'emotional': '×©×™×—×•×ª ××™×©×™×•×ª ×œ×—×™×–×•×§ ××¡×•×’×œ×•×ª ×¢×¦××™×ª, ×–×™×”×•×™ ×—×•×–×§×•×ª.'
        },
        '×—×‘×¨×ª×™': {
            'school': '×œ××™×“×ª ×¢××™×ª×™× (Tutor-Tutee), ×”×¤×¡×§×•×ª ×¤×¢×™×œ×•×ª ××•×‘× ×•×ª, ×©×™×œ×•×‘ ×‘×§×‘×•×¦×•×ª ×¢× ×™×™×Ÿ.',
            'home': '×”×–×× ×ª ×—×‘×¨ ××—×“ ×”×‘×™×ª×” ×œ×¤×¢×™×œ×•×ª ××•×‘× ×™×ª, ×ª×™×•×•×š ×¡×™×˜×•××¦×™×•×ª ×—×‘×¨×ª×™×•×ª.',
            'tech': '×§×‘×•×¦×•×ª ×•×•××˜×¡××¤ ×›×™×ª×ª×™×•×ª ×× ×•×”×œ×•×ª, ××©×—×§×™ ×¨×©×ª ×©×™×ª×•×¤×™×™×.',
            'emotional': '× ×™×ª×•×— ××™×¨×•×¢×™× ×—×‘×¨×ª×™×™× (×‘×“×™×¢×‘×“) ×œ×œ× ×©×™×¤×•×˜×™×•×ª.'
        },
        '×”×ª× ×”×’×•×ª×™': {
            'school': '×‘× ×™×™×ª ×—×•×–×” ×”×ª× ×”×’×•×ª×™ ××™×©×™, ×—×™×–×•×§×™× ××™×™×“×™×™× ×•×—×™×•×‘×™×™×, ×–×™×”×•×™ ×˜×¨×™×’×¨×™×.',
            'home': '×ª×™××•× ×¦×™×¤×™×•×ª ××—×™×“ ×‘×™×Ÿ ×‘×™×ª ×œ×‘×™×ª ×”×¡×¤×¨, ×©×™×˜×ª ×”××¡×™××•× ×™×/×›×•×›×‘×™×.',
            'tech': '××¤×œ×™×§×¦×™×•×ª ×œ××¢×§×‘ ×”×ª× ×”×’×•×ª ×—×™×•×‘×™×ª (ClassDojo).',
            'emotional': '×œ×™××•×“ ×˜×›× ×™×§×•×ª ×”×¨×’×¢×” ×¢×¦××™×ª (× ×©×™××•×ª, ×¡×¤×™×¨×”).'
        },
        '×—×•×©×™/××•×˜×•×¨×™': {
            'school': '×©×™××•×© ×‘××‘×™×–×¨×™× ×ª×—×•×©×ª×™×™× (×›×“×•×¨ ×¤×™×–×™×•, ×’×•××™ ×œ×¨×’×œ×™×™×), ×”×ª×××ª ×©×•×œ×—×Ÿ ×•×›×™×¡×.',
            'home': '×—×•×’×™ ×¡×¤×•×¨×˜/×©×—×™×™×”, ×¤×¢×™×œ×•×ª ×‘××’×¨×© ×”××©×—×§×™×.',
            'tech': '××§×œ×“×ª ××•×ª×××ª, ×©×™××•×© ×‘×¢×›×‘×¨ ××¨×’×•× ×•××™.',
            'emotional': '×œ×’×™×˜×™××¦×™×” ×œ×¦×•×¨×š ×‘×ª× ×•×¢×”, ×”×™×× ×¢×•×ª ××”×¦×¤×” ×—×•×©×™×ª.'
        }
    }
    return strategies.get(domain, {
        'school': '×”×ª×××” ××™×©×™×ª ×œ×¤×™ ×¦×•×¨×š.', 'home': '-', 'tech': '-', 'emotional': '-'
    })

# --- ×¢×™×‘×•×“ × ×ª×•× ×™× (Data Processing) ---

def load_data(file):
    try:
        # ×”× ×—×”: ×”×§×•×‘×¥ ××ª×—×™×œ ××©×•×¨×” 2 (header=1) ×•×”×•× CSV
        # ×× ×™×© ×‘×¢×™×™×ª ×§×™×“×•×“, ×× ×¡×™× 'utf-8' ××• 'cp1255' (×¢×‘×¨×™×ª ×•×•×™× ×“×•×¡)
        try:
            df = pd.read_csv(file, header=1, encoding='utf-8')
        except UnicodeDecodeError:
            df = pd.read_csv(file, header=1, encoding='cp1255')
            
        # ×–×™×”×•×™ ×©×•×¨×•×ª ×¨××©×™×•×ª ×•×©×•×¨×•×ª ×¤×™×¨×•×˜ (×œ×¤×™ ×”××‘× ×” ×©×œ ×”×¢×•×’×Ÿ)
        # ×©×•×¨×•×ª ×–×•×’×™×•×ª = × ×ª×•× ×™× ×§×˜×’×•×¨×™××œ×™×™×
        main_rows = df.iloc[::2].copy().reset_index(drop=True)
        # ×©×•×¨×•×ª ××™-×–×•×’×™×•×ª = ×¤×™×¨×•×˜ ××œ×œ ×—×•×¤×©×™
        detail_rows = df.iloc[1::2].copy().reset_index(drop=True)
        
        # ××™×¤×•×™ ×©××•×ª ×¢××•×“×•×ª ××¤×ª×— ×œ×¢×‘×•×“×” ×¤× ×™××™×ª × ×•×—×”
        col_map = {
            'Unnamed: 0': 'Name',
            '×©×œ×™×˜×” ×‘××™×•×× ×•×™×•×ª ×”×©×¤×” (×“×‘×•×¨×” ×•×›×ª×•×‘×”) ×‘×”×ª×× ×œ××¦×•×¤×” ××‘× ×™ ×”×’×™×œ': 'Language',
            '×©×œ×™×˜×” ×‘××ª××˜×™×§×” ×‘×”×ª×× ×œ××¦×•×¤×” ××‘× ×™ ×”×’×™×œ': 'Math',
            '××•×˜×™×‘×¦×™×” ×•×”×¨×’×œ×™ ×œ××™×“×” ×‘×”×ª×× ×œ××¦×•×¤×” ××‘× ×™ ×”×’×™×œ': 'Motivation',
            '×”×™×‘×˜×™× ×¨×’×©×™×™× ×‘×”×ª×× ×œ××¦×•×¤×” ××‘× ×™ ×”×’×™×œ': 'Emotional',
            '×”×™×‘×˜×™× ×”×ª× ×”×’×•×ª×™×™× ×‘×”×ª×× ×œ××¦×•×¤×” ××‘× ×™ ×”×’×™×œ': 'Behavioral',
            '×”×™×‘×˜×™× ×—×‘×¨×ª×™×™× ×‘×”×ª×× ×œ××¦×•×¤×” ××‘× ×™ ×”×’×™×œ': 'Social',
            '×ª×¤×§×•×“×™ ×§×©×‘ ×•×¤×¢×œ×ª× ×•×ª ×™×ª×¨ ×‘×”×ª×× ×œ××¦×•×¤×” ××‘× ×™ ×”×’×™×œ': 'Attention',
            '×ª×¤×§×•×“ ×—×•×©×™ - ×ª× ×•×¢×ª×™ - ××¨×—×‘×™ ×‘×”×ª×× ×œ××¦×•×¤×” ××‘× ×™ ×”×’×™×œ': 'Sensory',
            '×”×ª×œ××™×“ ××’×œ×” ×¢× ×™×™×Ÿ ×•/××• ×—×•×–×§×•×ª ×‘×ª×—×•× ×™×™×—×•×“×™ ××—×“ ××• ×™×•×ª×¨': 'Strengths_Bool',
            '×”×™×‘×˜×™× ××™×©×™×™× ×•/××• ××©×¤×—×ª×™×™× ×©×™×© ×œ×ª×ª ×¢×œ×™×”× ××ª ×”×“×¢×ª': 'Family',
        }
        
        # ×©×™× ×•×™ ×©××•×ª ×¢××•×“×•×ª ×¨×§ ×× ×§×™×™××•×ª
        existing_cols = {k: v for k, v in col_map.items() if k in main_rows.columns}
        main_rows.rename(columns=existing_cols, inplace=True)
        
        # ×”×•×¡×¤×ª ×¢××•×“×•×ª ×¤×™×¨×•×˜ ××”×©×•×¨×•×ª ×”××™-×–×•×’×™×•×ª
        # ×”× ×—×”: ×”×¢××•×“×•×ª ×‘××™×§×•× ×–×”×”. ×œ×•×§×—×™× ××ª ×”×¤×™×¨×•×˜ ×©×œ ×”×—×•×–×§×•×ª ×•×”××¢× ×™×
        if '×”×ª×œ××™×“ ××’×œ×” ×¢× ×™×™×Ÿ ×•/××• ×—×•×–×§×•×ª ×‘×ª×—×•× ×™×™×—×•×“×™ ××—×“ ××• ×™×•×ª×¨' in detail_rows.columns:
            main_rows['Strengths_Detail'] = detail_rows['×”×ª×œ××™×“ ××’×œ×” ×¢× ×™×™×Ÿ ×•/××• ×—×•×–×§×•×ª ×‘×ª×—×•× ×™×™×—×•×“×™ ××—×“ ××• ×™×•×ª×¨']
        
        main_rows['Name'] = main_rows['Name'].fillna('×œ×œ× ×©×')
        return main_rows

    except Exception as e:
        st.error(f"×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: {e}")
        return None

def analyze_challenges(row):
    """××—×–×™×¨×” ×¨×©×™××ª ××ª×’×¨×™× ×¢×‘×•×¨ ×©×•×¨×” (×ª×œ××™×“)"""
    challenges = []
    # ××™×¤×•×™ ×©× ×¢××•×“×” ×¤× ×™××™ -> ×©× ×ª×¦×•×’×” ×‘×¢×‘×¨×™×ª
    domain_labels = {
        'Language': '×©×¤×”', 'Math': '××ª××˜×™×§×”', 'Motivation': '××•×˜×™×‘×¦×™×” ×•×”×¨×’×œ×™ ×œ××™×“×”',
        'Emotional': '×¨×’×©×™', 'Behavioral': '×”×ª× ×”×’×•×ª×™', 'Social': '×—×‘×¨×ª×™',
        'Attention': '×§×©×‘', 'Sensory': '×—×•×©×™/××•×˜×•×¨×™'
    }
    
    for col, label in domain_labels.items():
        # ×‘×“×™×§×” ×× ×§×™×™× ×‘× ×ª×•× ×™×, ×œ× ×¨×™×§, ×•×œ× "×ª×§×™×Ÿ"
        if col in row and pd.notnull(row[col]) and str(row[col]).strip() != '×ª×§×™×Ÿ':
            challenges.append(label)
    return challenges

# --- ×¤×•× ×§×¦×™×•×ª ×™×™×¦×•× (Export) ---
def to_excel_download_link(df, filename="plan.xlsx"):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='Plan')
    processed_data = output.getvalue()
    b64 = base64.b64encode(processed_data).decode()
    return f'<a href="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{b64}" download="{filename}" class="stButton" style="text-decoration:none; color:black; background-color:#f0f2f6; padding:8px; border-radius:5px; border:1px solid gray;">ğŸ“¥ ×”×•×¨×“ ×›×§×•×‘×¥ Excel</a>'

# ==========================================
# Main App Logic
# ==========================================

st.title("âš“ ×× ×ª×•× ×™ '×”×¢×•×’×Ÿ' ×œ×ª×•×›× ×™×ª ×¢×‘×•×“×” ×›×™×ª×ª×™×ª ×•××™×©×™×ª")
st.markdown("""
**×‘×¨×•×›×” ×”×‘××” ×œ×›×œ×™ ×œ×ª×›× ×•×Ÿ ×”×ª×¢×¨×‘×•×™×•×ª.** ×›×œ×™ ×–×” ×× ×ª×— ××ª ×§×•×‘×¥ ×”× ×ª×•× ×™× ××”××™×¤×•×™, ×•××¤×™×§ ×ª×•×›× ×™×ª ×¢×‘×•×“×” ××‘×•×¡×¡×ª × ×ª×•× ×™× ×‘×¨×•×— ×”-MTSS ×•×”×¢×™×¦×•×‘ ×”××•× ×™×‘×¨×¡×œ×™ (UDL).
""")

# --- Sidebar: ×˜×¢×™× ×ª ×§×•×‘×¥ ---
with st.sidebar:
    st.header("1. ×˜×¢×™× ×ª × ×ª×•× ×™×")
    uploaded_file = st.file_uploader("×˜×¢×Ÿ ×§×•×‘×¥ CSV (×”×•×¨×“×” ××”×›×œ×™ ×”×‘×™×ª ×¡×¤×¨×™)", type=['csv'])
    st.info("ğŸ’¡ ×”×§×•×‘×¥ ×—×™×™×‘ ×œ×”×™×•×ª ×‘×¤×•×¨××˜ ×”××§×•×¨×™ ×©×œ ×›×œ×™ ×”×¢×•×’×Ÿ (×©×•×¨×•×ª ×›×¤×•×œ×•×ª).")
    st.markdown("---")
    st.write("×¤×•×ª×— ×¢×‘×•×¨ ×¨×›×–×•×ª ×”×©×ª×œ×‘×•×ª ×•××—× ×›×•×ª.")

if uploaded_file:
    df = load_data(uploaded_file)
    
    if df is not None:
        # ×¢×™×‘×•×“ ×¨××©×•× ×™ ×œ×›×œ ×”×ª×œ××™×“×™×
        df['Challenges_List'] = df.apply(analyze_challenges, axis=1)
        df['Num_Challenges'] = df['Challenges_List'].apply(len)
        
        # --- ×™×¦×™×¨×ª ×œ×©×•× ×™×•×ª ---
        tab_class, tab_personal = st.tabs(["ğŸ« ×ª×•×›× ×™×ª ×¢×‘×•×“×” ×›×™×ª×ª×™×ª", "ğŸ‘¤ ×ª×•×›× ×™×ª ×¢×‘×•×“×” ××™×©×™×ª"])
        
        # ==========================================
        # TAB 1: ×ª×•×›× ×™×ª ×›×™×ª×ª×™×ª
        # ==========================================
        with tab_class:
            st.header("×ª×•×›× ×™×ª ×¢×‘×•×“×” ×›×™×ª×ª×™×ª ××™× ×˜×’×¨×˜×™×‘×™×ª")
            
            # 1. × ×™×ª×•×— × ×ª×•× ×™× (Data Story)
            all_challenges_flat = [item for sublist in df['Challenges_List'] for item in sublist]
            challenge_counts = pd.Series(all_challenges_flat).value_counts()
            
            col_nar1, col_nar2 = st.columns([2, 1])
            
            with col_nar1:
                st.subheader("ğŸ“– ×”×¡×™×¤×•×¨ ×”×›×™×ª×ª×™: ×—×•×–×§×•×ª ×•××ª×’×¨×™×")
                
                # ××ª×’×¨×™× ××•×‘×™×œ×™×
                top_challenges = challenge_counts.head(4)
                st.write("**××ª×’×¨×™× ××¨×›×–×™×™× ×‘×›×™×ª×”:**")
                for domain, count in top_challenges.items():
                    percentage = int((count / len(df)) * 100)
                    # ×¨×©×™××ª ×”×ª×œ××™×“×™× ×‘××ª×’×¨ ×–×”
                    students_in_domain = df[df['Challenges_List'].apply(lambda x: domain in x)]['Name'].tolist()
                    with st.expander(f"ğŸ”´ **{domain}**: {count} ×ª×œ××™×“×™× ({percentage}%)"):
                        st.write(f"×ª×œ××™×“×™×: {', '.join(students_in_domain)}")

                # ×—×•×–×§×•×ª
                st.write("**×—×•×–×§×•×ª ×›×™×ª×ª×™×•×ª:**")
                strengths_text = df['Strengths_Detail'].dropna().astype(str).tolist()
                # ×–×™×”×•×™ ××™×œ×•×ª ××¤×ª×— ×‘×¡×™×¡×™ ×‘×—×•×–×§×•×ª (×¤×©×˜× ×™)
                strength_keywords = []
                for s in strengths_text:
                    if '×¦×™×•×¨' in s or '××•×× ×•×ª' in s: strength_keywords.append('××•×× ×•×ª ×•×™×¦×™×¨×”')
                    if '×¡×¤×•×¨×˜' in s or '×ª× ×•×¢×”' in s or '×›×“×•×¨×’×œ' in s: strength_keywords.append('×¡×¤×•×¨×˜ ×•×ª× ×•×¢×”')
                    if '××•×–×™×§×”' in s: strength_keywords.append('××•×–×™×§×”')
                    if '×—×‘×¨×ª×™' in s or '×¢×•×–×¨' in s: strength_keywords.append('×× ×”×™×’×•×ª ×—×‘×¨×ª×™×ª')
                
                common_strengths = pd.Series(strength_keywords).value_counts().head(3)
                if not common_strengths.empty:
                    st.success(f"×”×›×™×ª×” ××ª××¤×™×™× ×ª ×‘×—×•×–×§×•×ª ×‘×•×œ×˜×•×ª ×‘×ª×—×•××™×: **{', '.join(common_strengths.index)}**.")
                else:
                    st.write("×™×© ×œ×¢×™×™×Ÿ ×‘×¤×™×¨×•×˜ ×”×—×•×–×§×•×ª ×‘×¨××ª ×”×¤×¨×˜.")

            with col_nar2:
                st.subheader("××‘×˜ ×¢×œ")
                st.metric("×¡×”\"×› ×ª×œ××™×“×™×", len(df))
                intensive_count = len(df[df['Num_Challenges'] >= 4])
                st.metric("×ª×œ××™×“×™× ×‘×¨×•×‘×“ ×¤×¨×˜× ×™ (4+ ×§×©×™×™×)", intensive_count, delta_color="inverse")
                
            st.markdown("---")
            
            # 2. ×˜×‘×œ×ª ×ª×•×›× ×™×ª ×¢×‘×•×“×” (MTSS Table)
            st.subheader("ğŸ“‹ ×ª×•×›× ×™×ª ×¢×‘×•×“×” ×œ×¤×™ ××•×“×œ MTSS")
            
            plan_rows = []
            
            # A. ×¨×•×‘×“ ××•× ×™×‘×¨×¡×œ×™
            universal_goals = top_challenges.index[:2].tolist() if not top_challenges.empty else ["×œ××™×“×” ×¨×’×©×™×ª-×—×‘×¨×ª×™×ª"]
            
            for goal in universal_goals:
                strategies = get_domain_strategies(goal)
                plan_rows.append({
                    '×¨×•×‘×“': '××•× ×™×‘×¨×¡×œ×™ (×›×œ ×”×›×™×ª×”)',
                    '×©××•×ª ×ª×œ××™×“×™×': '×›×œ×œ ×”×›×™×ª×”',
                    '×ª×—×•×': goal,
                    '×™×¢×“×™× ××•×¤×¨×˜×™×‘×™×™×': f'×§×™×“×•× ××™×•×× ×•×™×•×ª {goal} ×›×—×œ×§ ××©×’×¨×ª ×”×›×™×ª×”',
                    '×‘×ª×•×š ×‘×™×”"×¡ (UDL)': strategies['school'],
                    '×‘×‘×™×ª/×”×•×¨×™×': strategies['home'],
                    '×›×œ×™× ×˜×›× ×•×œ×•×’×™×™×': strategies['tech'],
                    '××¢× ×” ×¨×’×©×™': strategies['emotional'],
                    '××“×“×™ ×”×¦×œ×—×”': '80% ××”×ª×œ××™×“×™× ×™×¤×’×™× ×• ×©×™×¤×•×¨ ×‘××‘×“×§ ×××¦×¢ ×©× ×”',
                    '×œ×•"×– ×•××¢×§×‘': '×™×™×©×•× ×™×•××™×•××™, ××¢×§×‘ ×‘××¡×™×¤×ª ××—×¦×™×ª'
                })
            
            # B. ×¨×•×‘×“ ×××•×§×“ (Targeted)
            # ×‘×—×™×¨×ª ×§×‘×•×¦×•×ª ×§×˜× ×•×ª (×œ××©×œ ×œ×ª×—×•××™× ×‘××§×•××•×ª 3-4 ××• ×¡×¤×¦×™×¤×™×™× ×›××• ×§×¨×™××”)
            targeted_goals = top_challenges.index[2:4].tolist() if len(top_challenges) > 2 else []
            if '×©×¤×”' in top_challenges.index and '×©×¤×”' not in targeted_goals: targeted_goals.append('×©×¤×”') # ×©×¤×” ×ª××™×“ ×¨×œ×•×•× ×˜×™×ª ×œ×§×‘×•×¦×•×ª
            
            for goal in targeted_goals:
                students = df[df['Challenges_List'].apply(lambda x: goal in x)]['Name'].tolist()
                # ×¡×™× ×•×Ÿ: ×¨×§ ××™ ×©×œ× ×‘×˜×™×¤×•×œ ×¤×¨×˜× ×™ ×××¡×™×‘×™ (××•×¤×¦×™×•× ×œ×™, ×›××Ÿ × ×©××™×¨ ××ª ×›×•×œ×)
                strategies = get_domain_strategies(goal)
                
                plan_rows.append({
                    '×¨×•×‘×“': '×××•×§×“ (×§×‘×•×¦×ª×™)',
                    '×©××•×ª ×ª×œ××™×“×™×': ', '.join(students[:5]) + (f' (+{len(students)-5} × ×•×¡×¤×™×)' if len(students)>5 else ''),
                    '×ª×—×•×': goal,
                    '×™×¢×“×™× ××•×¤×¨×˜×™×‘×™×™×': '×¦××¦×•× ×¤×¢×¨×™× ×•×—×™×–×•×§ ××™×•×× ×•×™×•×ª ×™×¡×•×“',
                    '×‘×ª×•×š ×‘×™×”"×¡ (UDL)': '×”×•×¨××” ××ª×§× ×ª ×‘×§×‘×•×¦×” ×§×˜× ×” (3-5 ×ª×œ××™×“×™×), ×”×˜×¨××” ×œ×¤× ×™ ×©×™×¢×•×¨.',
                    '×‘×‘×™×ª/×”×•×¨×™×': '×ª×¨×’×•×œ ×××•×§×“ ×¤×¢××™×™× ×‘×©×‘×•×¢.',
                    '×›×œ×™× ×˜×›× ×•×œ×•×’×™×™×': '×œ×•××“×” ××•×ª×××ª ××™×©×™×ª.',
                    '××¢× ×” ×¨×’×©×™': '×—×™×–×•×§ ×ª×—×•×©×ª ××¡×•×’×œ×•×ª ×‘×§×‘×•×¦×ª ×”×©×•×•×™×.',
                    '××“×“×™ ×”×¦×œ×—×”': '×¢××™×“×” ×‘×™×¢×“×™ ×ª×•×›× ×™×ª ×”×ª×¢×¨×‘×•×ª ×§×¦×¨×” (6 ×©×‘×•×¢×•×ª).',
                    '×œ×•"×– ×•××¢×§×‘': '××¤×’×© ×©×‘×•×¢×™, ××—×¨××™×ª: ××•×¨×ª ×©×™×œ×•×‘/××—× ×›×ª'
                })

            # C. ×¨×•×‘×“ ×¤×¨×˜× ×™ (Intensive)
            intensive_students_names = df[df['Num_Challenges'] >= 4]['Name'].tolist()
            if intensive_students_names:
                plan_rows.append({
                    '×¨×•×‘×“': '×¤×¨×˜× ×™ (××™×©×™)',
                    '×©××•×ª ×ª×œ××™×“×™×': ', '.join(intensive_students_names),
                    '×ª×—×•×': '×¨×‘-×ª×—×•××™',
                    '×™×¢×“×™× ××•×¤×¨×˜×™×‘×™×™×': '×‘× ×™×™×ª ×ª×•×›× ×™×ª ××™×©×™×ª (×ª×—"×/×ª×œ"×)',
                    '×‘×ª×•×š ×‘×™×”"×¡ (UDL)': '×”×ª×××•×ª ××™×©×™×•×ª ×‘×”×™×‘×—× ×•×ª ×•×‘×œ××™×“×”, ×¡×™×™×¢×ª (×× ×™×© ×–×›××•×ª), ×©×™×—×•×ª ×™×•×¢×¦×ª.',
                    '×‘×‘×™×ª/×”×•×¨×™×': '×”×“×¨×›×ª ×”×•×¨×™× ×§×‘×•×¢×”, ×§×©×¨ ×¨×¦×™×£ ×¢× ×”××—× ×›×ª.',
                    '×›×œ×™× ×˜×›× ×•×œ×•×’×™×™×': '×˜×›× ×•×œ×•×’×™×” ××¡×™×™×¢×ª ××•×ª×××ª ××™×©×™×ª.',
                    '××¢× ×” ×¨×’×©×™': '×˜×™×¤×•×œ ×¨×’×©×™ (×‘××× ×•×™×•×ª/×‘×¢"×—) ×‘××™×“×ª ×”××¤×©×¨.',
                    '××“×“×™ ×”×¦×œ×—×”': '×¢××™×“×” ×‘×™×¢×“×™× ×”××™×©×™×™× ×©×”×•×’×“×¨×• ×‘×ª×œ"×.',
                    '×œ×•"×– ×•××¢×§×‘': '××¢×§×‘ ×—×•×“×©×™ ×©×œ ×”×¦×•×•×ª ×”×¨×‘-××§×¦×•×¢×™'
                })

            # ×”×¦×’×ª ×”×˜×‘×œ×”
            class_plan_df = pd.DataFrame(plan_rows)
            st.table(class_plan_df)
            
            # ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×”
            col_d1, col_d2 = st.columns(2)
            with col_d1:
                st.markdown(to_excel_download_link(class_plan_df, "Class_Plan_MTSS.xlsx"), unsafe_allow_html=True)
            with col_d2:
                st.button("ğŸ–¨ï¸ ×”×“×¤×¡ ×ª×•×›× ×™×ª ×›×™×ª×ª×™×ª", on_click=None, help="×œ×—×¥ Ctrl+P ×‘×“×¤×“×¤×Ÿ ×œ×”×“×¤×¡×”")

        # ==========================================
        # TAB 2: ×ª×•×›× ×™×ª ××™×©×™×ª
        # ==========================================
        with tab_personal:
            st.header("×‘× ×™×™×ª ×ª×•×›× ×™×ª ×¢×‘×•×“×” ××™×©×™×ª")
            
            # ×‘×—×™×¨×ª ×ª×œ××™×“
            student_list = df['Name'].unique().tolist()
            selected_student = st.selectbox("×‘×—×¨ ×ª×œ××™×“ ×œ×”×¦×’×ª ×ª×•×›× ×™×ª:", student_list)
            
            if selected_student:
                # ×©×œ×™×¤×ª × ×ª×•× ×™ ×ª×œ××™×“
                stu_data = df[df['Name'] == selected_student].iloc[0]
                stu_challenges = stu_data['Challenges_List']
                stu_strengths = stu_data.get('Strengths_Detail', '×œ× ×¦×•×™×Ÿ')
                
                # --- ×”×—×œ×§ ×”×¢×œ×™×•×Ÿ: ×”×¡×™×¤×•×¨ ×”××™×©×™ ---
                st.subheader(f"×”×¡×™×¤×•×¨ ×©×œ {selected_student}")
                
                col_s1, col_s2, col_s3 = st.columns(3)
                with col_s1:
                    st.success("**âœ¨ ×—×•×–×§×•×ª ×•×ª×—×•××™ ×¢× ×™×™×Ÿ**")
                    st.write(stu_strengths)
                with col_s2:
                    st.error("**ğŸš© ××ª×’×¨×™× ××–×•×”×™×**")
                    if stu_challenges:
                        for c in stu_challenges:
                            st.write(f"â€¢ {c}")
                    else:
                        st.write("×œ×œ× ××ª×’×¨×™× ××©××¢×•×ª×™×™× ×‘×§×•×‘×¥ ×–×”.")
                with col_s3:
                    st.info("**ğŸ¯ ×™×¢×“×™ ×¢×‘×•×“×” ××¨×›×–×™×™×**")
                    if stu_challenges:
                        st.write(f"1. ×—×™×–×•×§ ×ª×¤×§×•×“ ×‘×ª×—×•×: {stu_challenges[0]}")
                        if len(stu_challenges) > 1:
                            st.write(f"2. ×©×™×¤×•×¨ ××™×•×× ×•×™×•×ª ×‘{stu_challenges[1]}")
                        st.write("3. ×”×¢×¦××” ××™×©×™×ª ×“×¨×š ×ª×—×•××™ ×”×—×•×–×§")
                    else:
                        st.write("×©×™××•×¨ ××¦×‘ ×§×™×™× ×•×§×™×“×•× ××¦×•×™× ×•×ª.")

                st.markdown("---")
                
                # --- ×”×—×œ×§ ×”×ª×—×ª×•×Ÿ: ×˜×‘×œ×” ××™×©×™×ª ---
                st.subheader("×ª×•×›× ×™×ª ×”×ª×¢×¨×‘×•×ª ××™×©×™×ª (MTSS)")
                
                personal_rows = []
                
                # ×™×¦×™×¨×ª ×©×•×¨×•×ª ×œ×˜×‘×œ×” ×œ×¤×™ ×”××ª×’×¨×™×
                for domain in stu_challenges:
                    strat = get_domain_strategies(domain)
                    personal_rows.append({
                        '×¨×•×‘×“': '×”×ª×¢×¨×‘×•×ª',
                        '×ª×—×•×': domain,
                        '×™×¢×“×™× ××“×™×“×™×': f'×©×™×¤×•×¨ ×‘{domain}, ×¦××¦×•× ×”×ª× ×”×’×•×ª × ×× ×¢×ª.',
                        '×¤×¢×•×œ×•×ª ×‘×™×”"×¡ (UDL)': strat['school'],
                        '×¤×¢×•×œ×•×ª ×‘×‘×™×ª': strat['home'],
                        '×˜×›× ×•×œ×•×’×™×”': strat['tech'],
                        '××¢× ×” ×¨×’×©×™': strat['emotional'],
                        '××“×“×™ ×”×¦×œ×—×”': '×“×™×•×•×— ×¢×¦××™ ×©×œ ×”×ª×œ××™×“ + ×ª×¦×¤×™×ª ××•×¨×”.',
                        '××—×¨××™ ×•×œ×•"×–': '××—× ×›×ª, ×‘×“×™×§×” ×‘×¢×•×“ ×—×•×“×©'
                    })
                
                # ×©×•×¨×” ×œ×©×™××•×¨ ×—×•×–×§×•×ª (×ª××™×“ ×—×©×•×‘!)
                personal_rows.append({
                    '×¨×•×‘×“': '×©×™××•×¨ ×•×—×™×–×•×§',
                    '×ª×—×•×': '×—×•×–×§×•×ª ××™×©×™×•×ª',
                    '×™×¢×“×™× ××“×™×“×™×': '×‘×™×˜×•×™ ×©×œ ×”×—×•×–×§×” (×¦×™×•×¨/×¡×¤×•×¨×˜ ×•×›×•\') ×‘×ª×•×¦×¨×™ ×œ××™×“×”.',
                    '×¤×¢×•×œ×•×ª ×‘×™×”"×¡ (UDL)': '××ª×Ÿ ××¤×©×¨×•×™×•×ª ×‘×—×™×¨×” ×‘×“×¨×›×™ ×”×™×‘×—× ×•×ª ×•×”×’×©×”.',
                    '×¤×¢×•×œ×•×ª ×‘×‘×™×ª': '×—×™×–×•×§ ×•×”×¢×¦××” ×©×œ ×”×ª×—×‘×™×‘.',
                    '×˜×›× ×•×œ×•×’×™×”': '-',
                    '××¢× ×” ×¨×’×©×™': '×©×™××•×© ×‘×—×•×–×§×” ×›××§×•×¨ ×œ×—×•×¡×Ÿ ×‘×¢×ª ××©×‘×¨.',
                    '××“×“×™ ×”×¦×œ×—×”': '×”×ª×œ××™×“ ××©×ª××© ×‘×—×•×–×§×” ×‘×©×™×¢×•×¨×™×.',
                    '××—×¨××™ ×•×œ×•"×–': '×¨×¦×™×£'
                })

                personal_df = pd.DataFrame(personal_rows)
                st.table(personal_df)
                
                # ×›×¤×ª×•×¨×™ ×”×•×¨×“×”
                col_p1, col_p2 = st.columns(2)
                with col_p1:
                    st.markdown(to_excel_download_link(personal_df, f"Plan_{selected_student}.xlsx"), unsafe_allow_html=True)
                with col_p2:
                    st.button("ğŸ–¨ï¸ ×”×“×¤×¡ ×ª×•×›× ×™×ª ××™×©×™×ª", on_click=None)

else:
    # ××¡×š ×¤×ª×™×—×” ×œ×¤× ×™ ×˜×¢×™× ×ª ×§×•×‘×¥
    st.info("×× × ×˜×¢× ×™ ××ª ×§×•×‘×¥ ×”× ×ª×•× ×™× (CSV) ×‘×¡×¨×’×œ ×”×¦×“ ×›×“×™ ×œ×”×ª×—×™×œ ×‘× ×™×ª×•×—.")
    st.write("×”×§×•×‘×¥ ×¦×¨×™×š ×œ×”×›×™×œ × ×ª×•× ×™ '×¢×•×’×Ÿ' ×¢× ×©×•×¨×ª ×›×•×ª×¨×ª, ×•×©×•×¨×•×ª ××ª×—×œ×¤×•×ª (×©× ×ª×œ××™×“ -> ×¤×™×¨×•×˜).")
